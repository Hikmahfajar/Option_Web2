<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
        <meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <link rel="stylesheet" href="css/leaflet.css">
        <link rel="stylesheet" href="css/L.Control.Layers.Tree.css">
        <link rel="stylesheet" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/fontawesome-all.min.css">
        <link rel="stylesheet" href="css/leaflet.photon.css">
        <style>
        /* Responsive full-screen map */
        html, body {height: 100%; margin: 0; padding: 0;}
        #map { width: 100%; height: 100vh; }

        /* Floating controls: legend & info */
        .legend-container {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(255,255,255,0.95);
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            padding: 8px 10px;
            max-height: 70vh;
            overflow: auto;
            font-family: 'Open Sans', Arial, sans-serif;
            font-size: 13px;
        }
        .legend-title { font-weight: 700; margin-bottom: 6px; }
        .legend-item { margin: 4px 0; display:flex; align-items:center; }
        .legend-color { width: 18px; height: 12px; margin-right: 8px; border-radius:2px; border:1px solid #ccc; }

        /* Popup table small cleanup */
        .leaflet-popup-content table { width: 100%; font-size: 13px; border-collapse: collapse; }
        .leaflet-popup-content td { padding: 4px 6px; border-bottom: 1px solid #eee; }

        /* Make layer tree button fit */
        .leaflet-control-layers { max-height: 60vh; overflow: auto; }
        </style>
        <title>Webmap</title>
    </head>
    <body>
        <div id="map"></div>

        <!-- Legend / Layer toggles -->
        <div class="legend-container" id="legend">
            <div class="legend-title">Layers</div>
            <div id="legend-list"></div>
        </div>

        <script src="js/qgis2web_expressions.js"></script>
        <script src="js/leaflet.js"></script>
        <script src="js/L.Control.Layers.Tree.min.js"></script>
        <script src="js/leaflet.rotatedMarker.js"></script>
        <script src="js/leaflet.pattern.js"></script>
        <script src="js/leaflet-hash.js"></script>
        <script src="js/Autolinker.min.js"></script>
        <script src="js/rbush.min.js"></script>
        <script src="js/labelgun.min.js"></script>
        <script src="js/labels.js"></script>
        <script src="js/leaflet.photon.js"></script>

        <!-- GeoJSON / data files generated by qgis2web -->
        <script src="data/UpstreamDownstreamBoundary_9.js"></script>
        <script src="data/GramaNiladhariDivisionBoundary_10.js"></script>
        <script src="data/DivisionalSecretariatDivisionBoundary_11.js"></script>
        <script src="data/DistrictBoundary_12.js"></script>
        <script src="data/ProvienceBoundary_13.js"></script>
        <script src="data/ProjectBoundary_14.js"></script>

        <script>
        // --- Helpers ---
        var autolinker = new Autolinker({truncate: {length: 30, location: 'smart'}});
        function removeEmptyRowsFromPopupContent(content, feature) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var rows = tempDiv.querySelectorAll('tr');
            for (var i = 0; i < rows.length; i++) {
                var td = rows[i].querySelector('td.visible-with-data');
                var key = td ? td.id : '';
                if (td && td.classList.contains('visible-with-data') && feature.properties[key] == null) {
                    rows[i].parentNode.removeChild(rows[i]);
                }
            }
            return tempDiv.innerHTML;
        }

        function addClassToPopupIfMedia(content, popup) {
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = content;
            var imgTd = tempDiv.querySelector('td img');
            if (imgTd) {
                var src = imgTd.getAttribute('src');
                if (/\.(jpg|jpeg|png|gif|bmp|webp|avif)$/i.test(src)) {
                    popup._contentNode.classList.add('media');
                    setTimeout(function() { popup.update(); }, 10);
                } else if (/\.(mp3|wav|ogg|aac)$/i.test(src)) {
                    var audio = document.createElement('audio'); audio.controls = true; audio.src = src;
                    imgTd.parentNode.replaceChild(audio, imgTd);
                    popup._contentNode.classList.add('media');
                    setTimeout(function() { popup.setContent(tempDiv.innerHTML); popup.update(); }, 10);
                } else if (/\.(mp4|webm|ogg|mov)$/i.test(src)) {
                    var video = document.createElement('video'); video.controls = true; video.src = src;
                    video.style.width = "400px"; video.style.height = "300px";
                    imgTd.parentNode.replaceChild(video, imgTd);
                    popup._contentNode.classList.add('media');
                    video.addEventListener('loadedmetadata', function() { popup.update(); });
                    setTimeout(function() { popup.setContent(tempDiv.innerHTML); popup.update(); }, 10);
                } else {
                    popup._contentNode.classList.remove('media');
                }
            } else {
                popup._contentNode.classList.remove('media');
            }
        }

        // --- Map creation ---
        var map = L.map('map', { zoomControl:false, maxZoom:28, minZoom:1 });
        map.fitBounds([[7.13856801708306,79.63365913783606],[8.452629076510629,81.7543511164057]]);
        var hash = new L.Hash(map);
        map.attributionControl.setPrefix('<a href="https://github.com/tomchadwin/qgis2web" target="_blank">qgis2web</a> &middot; <a href="https://leafletjs.com">Leaflet</a> &middot; <a href="https://qgis.org">QGIS</a>');

        // add zoom control (nicer position)
        L.control.zoom({ position: 'topleft' }).addTo(map);
        L.control.scale({ metric: true, imperial: false }).addTo(map);

        // --- Base layers ---
        map.createPane('pane_OpenStreetMap_0');
        map.getPane('pane_OpenStreetMap_0').style.zIndex = 400;
        var layer_OpenStreetMap_0 = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
            pane: 'pane_OpenStreetMap_0', opacity: 1.0, attribution: '', minZoom: 1, maxZoom: 28
        }).addTo(map);

        var esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
        var googleTerrain = L.tileLayer('https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}');

        var baseLayers = { 'OpenStreetMap': layer_OpenStreetMap_0, 'Esri Satellite': esriSat, 'Google Satellite': googleTerrain };

        // --- Image overlays (rasters exported by qgis2web) ---
        map.createPane('pane_LocationbasedPriorityInterventionOption_1'); map.getPane('pane_LocationbasedPriorityInterventionOption_1').style.zIndex = 401;
        var img_LocationbasedPriorityInterventionOption_1 = 'data/LocationbasedPriorityInterventionOption_1.png';
        var img_bounds_LocationbasedPriorityInterventionOption_1 = [[7.189866965445821,79.83172443102876],[8.440916378211442,81.06479260093205]];
        var layer_LocationbasedPriorityInterventionOption_1 = L.imageOverlay(img_LocationbasedPriorityInterventionOption_1, img_bounds_LocationbasedPriorityInterventionOption_1, {pane: 'pane_LocationbasedPriorityInterventionOption_1'});

        map.createPane('pane_Restorationandsustainableintensificationofplantations_2'); map.getPane('pane_Restorationandsustainableintensificationofplantations_2').style.zIndex = 402;
        var img_Restorationandsustainableintensificationofplantations_2 = 'data/Restorationandsustainableintensificationofplantations_2.png';
        var img_bounds_Restorationandsustainableintensificationofplantations_2 = [[7.189537946368948,79.82972509019021],[8.440562935775374,81.06277364521755]];
        var layer_Restorationandsustainableintensificationofplantations_2 = L.imageOverlay(img_Restorationandsustainableintensificationofplantations_2, img_bounds_Restorationandsustainableintensificationofplantations_2, {pane: 'pane_Restorationandsustainableintensificationofplantations_2'});

        map.createPane('pane_Sustainableintensificationofsmallholderproduction_3'); map.getPane('pane_Sustainableintensificationofsmallholderproduction_3').style.zIndex = 403;
        var img_Sustainableintensificationofsmallholderproduction_3 = 'data/Sustainableintensificationofsmallholderproduction_3.png';
        var img_bounds_Sustainableintensificationofsmallholderproduction_3 = [[7.189537946368948,79.82972509019021],[8.440562935775374,81.06277364521755]];
        var layer_Sustainableintensificationofsmallholderproduction_3 = L.imageOverlay(img_Sustainableintensificationofsmallholderproduction_3, img_bounds_Sustainableintensificationofsmallholderproduction_3, {pane: 'pane_Sustainableintensificationofsmallholderproduction_3'});

        map.createPane('pane_Increasingcroppingintensityofirrigatedriceinbothupstreamanddownstreamareas_4'); map.getPane('pane_Increasingcroppingintensityofirrigatedriceinbothupstreamanddownstreamareas_4').style.zIndex = 404;
        var img_Increasingcroppingintensityofirrigatedriceinbothupstreamanddownstreamareas_4 = 'data/Increasingcroppingintensityofirrigatedriceinbothupstreamanddownstreamareas_4.png';
        var img_bounds_Increasingcroppingintensityofirrigatedriceinbothupstreamanddownstreamareas_4 = [[7.189537946368948,79.82972509019021],[8.440562935775374,81.06277364521755]];
        var layer_Increasingcroppingintensityofirrigatedriceinbothupstreamanddownstreamareas_4 = L.imageOverlay(img_Increasingcroppingintensityofirrigatedriceinbothupstreamanddownstreamareas_4, img_bounds_Increasingcroppingintensityofirrigatedriceinbothupstreamanddownstreamareas_4, {pane: 'pane_Increasingcroppingintensityofirrigatedriceinbothupstreamanddownstreamareas_4'});

        map.createPane('pane_Restorationofforestmosaiclandscapes_5'); map.getPane('pane_Restorationofforestmosaiclandscapes_5').style.zIndex = 405;
        var img_Restorationofforestmosaiclandscapes_5 = 'data/Restorationofforestmosaiclandscapes_5.png';
        var img_bounds_Restorationofforestmosaiclandscapes_5 = [[7.189537946368948,79.82972509019021],[8.440562935775374,81.06277364521755]];
        var layer_Restorationofforestmosaiclandscapes_5 = L.imageOverlay(img_Restorationofforestmosaiclandscapes_5, img_bounds_Restorationofforestmosaiclandscapes_5, {pane: 'pane_Restorationofforestmosaiclandscapes_5'});

        map.createPane('pane_Rehabilitationandestablishmentofvillagetankspondsandirrigationnetworks_6'); map.getPane('pane_Rehabilitationandestablishmentofvillagetankspondsandirrigationnetworks_6').style.zIndex = 406;
        var img_Rehabilitationandestablishmentofvillagetankspondsandirrigationnetworks_6 = 'data/Rehabilitationandestablishmentofvillagetankspondsandirrigationnetworks_6.png';
        var img_bounds_Rehabilitationandestablishmentofvillagetankspondsandirrigationnetworks_6 = [[7.189537946368948,79.82972509019021],[8.440562935775374,81.06277364521755]];
        var layer_Rehabilitationandestablishmentofvillagetankspondsandirrigationnetworks_6 = L.imageOverlay(img_Rehabilitationandestablishmentofvillagetankspondsandirrigationnetworks_6, img_bounds_Rehabilitationandestablishmentofvillagetankspondsandirrigationnetworks_6, {pane: 'pane_Rehabilitationandestablishmentofvillagetankspondsandirrigationnetworks_6'});

        map.createPane('pane_Drainagemanagementalongroads_7'); map.getPane('pane_Drainagemanagementalongroads_7').style.zIndex = 407;
        var img_Drainagemanagementalongroads_7 = 'data/Drainagemanagementalongroads_7.png';
        var img_bounds_Drainagemanagementalongroads_7 = [[7.189537946368948,79.82972509019021],[8.440562935775374,81.06277364521755]];
        var layer_Drainagemanagementalongroads_7 = L.imageOverlay(img_Drainagemanagementalongroads_7, img_bounds_Drainagemanagementalongroads_7, {pane: 'pane_Drainagemanagementalongroads_7'});

        map.createPane('pane_Streamsideprotection_8'); map.getPane('pane_Streamsideprotection_8').style.zIndex = 408;
        var img_Streamsideprotection_8 = 'data/Streamsideprotection_8.png';
        var img_bounds_Streamsideprotection_8 = [[7.18955968808468,79.82969483840972],[8.440584741818853,81.0627434588095]];
        var layer_Streamsideprotection_8 = L.imageOverlay(img_Streamsideprotection_8, img_bounds_Streamsideprotection_8, {pane: 'pane_Streamsideprotection_8'});

        // --- Bounds group for fitBounds if needed ---
        var bounds_group = new L.featureGroup([]);
        bounds_group.addLayer(layer_LocationbasedPriorityInterventionOption_1);
        bounds_group.addLayer(layer_Restorationandsustainableintensificationofplantations_2);
        bounds_group.addLayer(layer_Sustainableintensificationofsmallholderproduction_3);
        bounds_group.addLayer(layer_Increasingcroppingintensityofirrigatedriceinbothupstreamanddownstreamareas_4);
        bounds_group.addLayer(layer_Restorationofforestmosaiclandscapes_5);
        bounds_group.addLayer(layer_Rehabilitationandestablishmentofvillagetankspondsandirrigationnetworks_6);
        bounds_group.addLayer(layer_Drainagemanagementalongroads_7);
        bounds_group.addLayer(layer_Streamsideprotection_8);

        // --- GeoJSON vector layers (admin boundaries) ---
        function highlightFeature(e) {
            var layer = e.target;
            if (layer.setStyle) {
                layer.setStyle({ weight: 4, color: '#ffff00', fillOpacity: 0.1 });
                if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) { layer.bringToFront(); }
            }
            if (layer.openPopup) layer.openPopup();
        }

        function resetHighlight(e) {
            var layer = e.target;
            if (layer.resetStyle) layer.resetStyle(e.target);
        }

        function bindPopupFromTemplate(feature, layer, propsOrder) {
            var popupContent = '<table>';
            propsOrder.forEach(function(p){
                popupContent += '<tr><td colspan="2">' + (feature.properties[p] !== null ? autolinker.link(String(feature.properties[p]).replace(/'/g, '\'').toLocaleString()) : '') + '</td></tr>';
            });
            popupContent += '</table>';
            var content = removeEmptyRowsFromPopupContent(popupContent, feature);
            layer.on('popupopen', function(e){ addClassToPopupIfMedia(content, e.popup); });
            layer.bindPopup(content, { maxHeight: 400 });
        }

        function styleByUpdo(feature) {
            switch(String(feature.properties['Updo'])) {
                case 'Upstream': return { color: 'rgba(177,10,57,1.0)', weight: 4, fillOpacity:0 };
                case 'Downstream': return { color: 'rgba(38,94,177,1.0)', weight: 4, fillOpacity:0 };
                default: return { color: '#333', weight: 2 };
            }
        }

        map.createPane('pane_UpstreamDownstreamBoundary_9'); map.getPane('pane_UpstreamDownstreamBoundary_9').style.zIndex = 409;
        map.getPane('pane_UpstreamDownstreamBoundary_9').style['mix-blend-mode'] = 'normal';
        var layer_UpstreamDownstreamBoundary_9 = new L.geoJson(json_UpstreamDownstreamBoundary_9, {
            pane: 'pane_UpstreamDownstreamBoundary_9', onEachFeature: function(feature, layer){
                layer.on({ mouseover: highlightFeature, mouseout: resetHighlight });
                bindPopupFromTemplate(feature, layer, ['OBJECTID','FID_Downst','Name','SIDT','Updo','FID_Upstre','Name_1','SIDT_1','Updo_1','Shape_Leng','Shape_Area','keterangan']);
            }, style: styleByUpdo
        });

        map.createPane('pane_GramaNiladhariDivisionBoundary_10'); map.getPane('pane_GramaNiladhariDivisionBoundary_10').style.zIndex = 410;
        map.getPane('pane_GramaNiladhariDivisionBoundary_10').style['mix-blend-mode'] = 'normal';
        var layer_GramaNiladhariDivisionBoundary_10 = new L.geoJson(json_GramaNiladhariDivisionBoundary_10, {
            pane: 'pane_GramaNiladhariDivisionBoundary_10', onEachFeature: function(feature, layer){
                layer.on({ mouseover: highlightFeature, mouseout: resetHighlight });
                bindPopupFromTemplate(feature, layer, ['OBJECTID','GND_N','Shape_Leng','Shape_Area']);
            }, style: function(){ return { color: 'rgba(17,2,2,1.0)', weight: 2, fillOpacity:0 }; }
        });

        map.createPane('pane_DivisionalSecretariatDivisionBoundary_11'); map.getPane('pane_DivisionalSecretariatDivisionBoundary_11').style.zIndex = 411;
        map.getPane('pane_DivisionalSecretariatDivisionBoundary_11').style['mix-blend-mode'] = 'normal';
        var layer_DivisionalSecretariatDivisionBoundary_11 = new L.geoJson(json_DivisionalSecretariatDivisionBoundary_11, {
            pane: 'pane_DivisionalSecretariatDivisionBoundary_11', onEachFeature: function(feature, layer){
                layer.on({ mouseover: highlightFeature, mouseout: resetHighlight });
                bindPopupFromTemplate(feature, layer, ['OBJECTID','DSD_N','Shape_Leng','Shape_Area','luas']);
            }, style: function(){ return { color: 'rgba(10,1,1,1.0)', weight: 2, fillOpacity:0 }; }
        });

        map.createPane('pane_DistrictBoundary_12'); map.getPane('pane_DistrictBoundary_12').style.zIndex = 412;
        map.getPane('pane_DistrictBoundary_12').style['mix-blend-mode'] = 'normal';
        var layer_DistrictBoundary_12 = new L.geoJson(json_DistrictBoundary_12, {
            pane: 'pane_DistrictBoundary_12', onEachFeature: function(feature, layer){
                layer.on({ mouseover: highlightFeature, mouseout: resetHighlight });
                bindPopupFromTemplate(feature, layer, ['OBJECTID','DISTRICT_N','Shape_Leng','Shape_Area']);
            }, style: function(){ return { color: 'rgba(12,1,2,1.0)', weight: 2, fillOpacity:0 }; }
        });

        map.createPane('pane_ProvienceBoundary_13'); map.getPane('pane_ProvienceBoundary_13').style.zIndex = 413;
        map.getPane('pane_ProvienceBoundary_13').style['mix-blend-mode'] = 'normal';
        var layer_ProvienceBoundary_13 = new L.geoJson(json_ProvienceBoundary_13, {
            pane: 'pane_ProvienceBoundary_13', onEachFeature: function(feature, layer){
                layer.on({ mouseover: highlightFeature, mouseout: resetHighlight });
                bindPopupFromTemplate(feature, layer, ['OBJECTID','PROVINCE_N','Shape_Leng','Shape_Area']);
            }, style: function(){ return { color: 'rgba(2,5,2,1.0)', weight: 2, fillOpacity:0 }; }
        });

        map.createPane('pane_ProjectBoundary_14'); map.getPane('pane_ProjectBoundary_14').style.zIndex = 414;
        map.getPane('pane_ProjectBoundary_14').style['mix-blend-mode'] = 'normal';
        var layer_ProjectBoundary_14 = new L.geoJson(json_ProjectBoundary_14, {
            pane: 'pane_ProjectBoundary_14', onEachFeature: function(feature, layer){
                layer.on({ mouseover: highlightFeature, mouseout: resetHighlight });
                bindPopupFromTemplate(feature, layer, ['OBJECTID','SIDT_1','Shape_Leng','Shape_Area']);
            }, style: function(){ return { color: 'rgba(228,26,28,1.0)', weight: 3, fillOpacity:0 }; }
        });

        // Add some default layers to the map (you can change this)
        layer_ProjectBoundary_14.addTo(map);
        layer_ProvienceBoundary_13.addTo(map);

        // --- Layer control (tree) ---
        var overlaysTree = [
            {
                label: 'Intervention Options',
                children: [
                    { label: 'Priority Option', layer: layer_LocationbasedPriorityInterventionOption_1 },
                    { label: 'Plantation Restoration', layer: layer_Restorationandsustainableintensificationofplantations_2 },
                    { label: 'Smallholder Intensification', layer: layer_Sustainableintensificationofsmallholderproduction_3 },
                    { label: 'Irrigated Rice Intensity', layer: layer_Increasingcroppingintensityofirrigatedriceinbothupstreamanddownstreamareas_4 },
                    { label: 'Forest Mosaic Restoration', layer: layer_Restorationofforestmosaiclandscapes_5 },
                    { label: 'Village Tanks & Ponds', layer: layer_Rehabilitationandestablishmentofvillagetankspondsandirrigationnetworks_6 },
                    { label: 'Road Drainage', layer: layer_Drainagemanagementalongroads_7 },
                    { label: 'Streamside Protection', layer: layer_Streamsideprotection_8 }
                ]
            },
            {
                label: 'Administrative Boundaries',
                children: [
                    { label: 'GND', layer: layer_GramaNiladhariDivisionBoundary_10 },
                    { label: 'DSD', layer: layer_DivisionalSecretariatDivisionBoundary_11 },
                    { label: 'District', layer: layer_DistrictBoundary_12 },
                    { label: 'Province', layer: layer_ProvienceBoundary_13 },
                    { label: 'Upstream / Downstream', layer: layer_UpstreamDownstreamBoundary_9 },
                    { label: 'Project Boundary', layer: layer_ProjectBoundary_14 }
                ]
            }
        ];

        L.control.layers.tree(baseLayers, overlaysTree, { collapsed: false, position: 'topright' }).addTo(map);

        // --- Custom permanent legend with checkboxes (for quick toggles) ---
        var legendList = document.getElementById('legend-list');
        var legendConfig = [
            {id: 'layer_LocationbasedPriorityInterventionOption_1', label: 'Priority Option (raster)', layer: layer_LocationbasedPriorityInterventionOption_1, color: '#ff7f00'},
            {id: 'layer_Restorationandsustainableintensificationofplantations_2', label: 'Plantation Restoration (raster)', layer: layer_Restorationandsustainableintensificationofplantations_2, color: '#66c2a5'},
            {id: 'layer_Sustainableintensificationofsmallholderproduction_3', label: 'Smallholder Intensification (raster)', layer: layer_Sustainableintensificationofsmallholderproduction_3, color: '#8da0cb'},
            {id: 'layer_Increasingcroppingintensityofirrigatedriceinbothupstreamanddownstreamareas_4', label: 'Irrigated Rice Intensity (raster)', layer: layer_Increasingcroppingintensityofirrigatedriceinbothupstreamanddownstreamareas_4, color: '#e78ac3'},
            {id: 'layer_Restorationofforestmosaiclandscapes_5', label: 'Forest Mosaic Restoration (raster)', layer: layer_Restorationofforestmosaiclandscapes_5, color: '#a6d854'},
            {id: 'layer_Rehabilitationandestablishmentofvillagetankspondsandirrigationnetworks_6', label: 'Village Tanks (raster)', layer: layer_Rehabilitationandestablishmentofvillagetankspondsandirrigationnetworks_6, color: '#ffd92f'},
            {id: 'layer_Drainagemanagementalongroads_7', label: 'Road Drainage (raster)', layer: layer_Drainagemanagementalongroads_7, color: '#e5c494'},
            {id: 'layer_Streamsideprotection_8', label: 'Streamside Protection (raster)', layer: layer_Streamsideprotection_8, color: '#b3b3b3'},

            {id: 'layer_GramaNiladhariDivisionBoundary_10', label: 'GND (vector)', layer: layer_GramaNiladhariDivisionBoundary_10, color: '#111'},
            {id: 'layer_DivisionalSecretariatDivisionBoundary_11', label: 'DSD (vector)', layer: layer_DivisionalSecretariatDivisionBoundary_11, color: '#0a0101'},
            {id: 'layer_DistrictBoundary_12', label: 'District (vector)', layer: layer_DistrictBoundary_12, color: '#0c0102'},
            {id: 'layer_ProvienceBoundary_13', label: 'Province (vector)', layer: layer_ProvienceBoundary_13, color: '#020502'},
            {id: 'layer_UpstreamDownstreamBoundary_9', label: 'Upstream / Downstream (vector)', layer: layer_UpstreamDownstreamBoundary_9, color: '#b10a39'},
            {id: 'layer_ProjectBoundary_14', label: 'Project Boundary (vector)', layer: layer_ProjectBoundary_14, color: '#e41a1c'}
        ];

        legendConfig.forEach(function(item){
            var row = document.createElement('div'); row.className = 'legend-item';
            var checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.id = item.id;
            // default: check vector boundaries and project boundary
            if (item.layer === layer_ProjectBoundary_14 || item.layer === layer_ProvienceBoundary_13) checkbox.checked = true;
            var colorBox = document.createElement('div'); colorBox.className = 'legend-color'; colorBox.style.background = item.color;
            var label = document.createElement('label'); label.htmlFor = item.id; label.style.cursor = 'pointer'; label.style.flex = '1'; label.innerText = item.label;
            row.appendChild(checkbox); row.appendChild(colorBox); row.appendChild(label);
            legendList.appendChild(row);

            checkbox.addEventListener('change', function(e){
                if (e.target.checked) {
                    if (!(map.hasLayer(item.layer))) map.addLayer(item.layer);
                } else {
                    if (map.hasLayer(item.layer)) map.removeLayer(item.layer);
                }
            });
        });

        // --- Label handling from qgis2web (kept) ---
        // Ensure labels array exists (labels.js from qgis2web expects it)
        if (typeof labels === 'undefined') window.labels = [];
        var totalMarkers = 0;

        // bind persistent tooltips for admin layers
        layer_GramaNiladhariDivisionBoundary_10.eachLayer(function(layer){
            if (layer.feature && layer.feature.properties && layer.feature.properties['GND_N']) {
                layer.bindTooltip("<div style='color:#323232;font-size:10pt;font-family:\'Open Sans\',sans-serif;">"+layer.feature.properties['GND_N']+"</div>", {permanent: true, offset: [-0, -16], className: 'css_GramaNiladhariDivisionBoundary_10'});
                labels.push(layer); totalMarkers++;
            }
        });
        layer_DivisionalSecretariatDivisionBoundary_11.eachLayer(function(layer){ if (layer.feature && layer.feature.properties && layer.feature.properties['DSD_N']) { layer.bindTooltip("<div style='color:#323232;font-size:10pt;font-family:\'Open Sans\',sans-serif;">"+layer.feature.properties['DSD_N']+"</div>", {permanent: true, offset: [-0, -16], className: 'css_DivisionalSecretariatDivisionBoundary_11'}); labels.push(layer); totalMarkers++; } });
        layer_DistrictBoundary_12.eachLayer(function(layer){ if (layer.feature && layer.feature.properties && layer.feature.properties['DISTRICT_N']) { layer.bindTooltip("<div style='color:#323232;font-size:10pt;font-family:\'Open Sans\',sans-serif;">"+layer.feature.properties['DISTRICT_N']+"</div>", {permanent: true, offset: [-0, -16], className: 'css_DistrictBoundary_12'}); labels.push(layer); totalMarkers++; } });
        layer_ProvienceBoundary_13.eachLayer(function(layer){ if (layer.feature && layer.feature.properties && layer.feature.properties['PROVINCE_N']) { layer.bindTooltip("<div style='color:#323232;font-size:10pt;font-family:\'Open Sans\',sans-serif;">"+layer.feature.properties['PROVINCE_N']+"</div>", {permanent: true, offset: [-0, -16], className: 'css_ProvienceBoundary_13'}); labels.push(layer); totalMarkers++; } });
        layer_ProjectBoundary_14.eachLayer(function(layer){ if (layer.feature && layer.feature.properties && layer.feature.properties['SIDT_1']) { layer.bindTooltip("<div style='color:#323232;font-size:10pt;font-family:\'Open Sans\',sans-serif;">"+layer.feature.properties['SIDT_1']+"</div>", {permanent: true, offset: [-0, -16], className: 'css_ProjectBoundary_14'}); labels.push(layer); totalMarkers++; } });

        // Ensure image overlays provide bounds for fit
        L.ImageOverlay.include({ getBounds: function () { return this._bounds; } });

        // Reset labels function (kept from qgis2web labels.js)
        if (typeof resetLabels === 'function') {
            resetLabels([layer_GramaNiladhariDivisionBoundary_10,layer_DivisionalSecretariatDivisionBoundary_11,layer_DistrictBoundary_12,layer_ProvienceBoundary_13,layer_ProjectBoundary_14]);
            map.on('zoomend layeradd layerremove', function(){ resetLabels([layer_GramaNiladhariDivisionBoundary_10,layer_DivisionalSecretariatDivisionBoundary_11,layer_DistrictBoundary_12,layer_ProvienceBoundary_13,layer_ProjectBoundary_14]); });
        }

        // OPTIONAL: Fit to bounds of raster overlays if none of base layers selected
        // map.fitBounds(bounds_group.getBounds());

        </script>
    </body>
</html>
